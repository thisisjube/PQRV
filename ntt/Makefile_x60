CC 		= gcc
OBJDUMP = objdump

COMMONDIR 		= ../common
KYBERNTTDIR		= ./kyber
DILITHIUMNTTDIR = ./dilithium

CFLAGS_COMMON 	= -Wall -Wextra -Wpedantic -Wmissing-prototypes -Wredundant-decls \
  				  -Wshadow -Wpointer-arith -O3 -fomit-frame-pointer  \
				  -I$(COMMONDIR) -I.

CFLAGS_RV64IM 	= $(CFLAGS_COMMON) -march=rv64imafdc -mabi=lp64d -DRV64=1
CFLAGS_RV64IMB 	= $(CFLAGS_COMMON) -march=rv64imafdc_zba_zbb -mabi=lp64d -DRV64=1
CFLAGS_RV64IMV 	= $(CFLAGS_COMMON) -march=rv64imafdcv -mabi=lp64d -DVECTOR128 -DRV64=1
CFLAGS_RV64IMBV = $(CFLAGS_COMMON) -march=rv64imafdcv_zba_zbb -mabi=lp64d -DVECTOR128 -DRV64=1

SOURCES_COMMON 	= $(COMMONDIR)/cpucycles.c $(COMMONDIR)/speed_print.c
HEADERS_COMMON 	= $(COMMONDIR)/cpucycles.h $(COMMONDIR)/speed_print.h

SOURCES			= speed_ntt.c

.PHONY: all run_all clean

all: \
	out/speed_singleissue_kyber_plantard_ntt_rv64	\
	out/speed_dualissue_kyber_plantard_ntt_rv64		\
	out/speed_dualissue_kyber_plantard_l32_ntt_rv64	\
	out/speed_dualissue_dilithium_plant_ntt_rv64	\
	out/speed_dualissue_kyber_mont_ntt_rvv			\
	out/speed_dualissue_dilithium_mont_ntt_rvv

run_all: all
	@echo "speed_singleissue_kyber_plantard_ntt_rv64:" >> speed_ntt_x60.txt
	perf stat ./out/speed_singleissue_kyber_plantard_ntt_rv64 >> speed_ntt_x60.txt 2>/dev/null
	@echo "\nspeed_dualissue_kyber_plantard_ntt_rv64:" >> speed_ntt_x60.txt
	perf stat ./out/speed_dualissue_kyber_plantard_ntt_rv64 >> speed_ntt_x60.txt 2>/dev/null
	@echo "\nspeed_dualissue_kyber_plantard_l32_ntt_rv64:" >> speed_ntt_x60.txt
	perf stat ./out/speed_dualissue_kyber_plantard_l32_ntt_rv64 >> speed_ntt_x60.txt 2>/dev/null
	@echo "\nspeed_dualissue_kyber_mont_ntt_rvv:" >> speed_ntt_x60.txt
	perf stat ./out/speed_dualissue_kyber_mont_ntt_rvv >> speed_ntt_x60.txt 2>/dev/null
	@echo "\nspeed_dualissue_dilithium_plant_ntt_rv64:" >> speed_ntt_x60.txt
	perf stat ./out/speed_dualissue_dilithium_plant_ntt_rv64 >> speed_ntt_x60.txt 2>/dev/null
	@echo "\nspeed_dualissue_dilithium_mont_ntt_rvv:" >> speed_ntt_x60.txt
	perf stat ./out/speed_dualissue_dilithium_mont_ntt_rvv >> speed_ntt_x60.txt 2>/dev/null

out/speed_singleissue_kyber_plantard_ntt_rv64: $(SOURCES_COMMON) $(SOURCES) $(HEADERS_COMMON) $(KYBERNTTDIR)/ntt_singleissue_plant_rv64im.S
	mkdir -p out
	$(CC) $(CFLAGS_RV64IM) -I$(KYBERNTTDIR) $(filter %.c, $^) $(filter %.S, $^) -o $@

out/speed_dualissue_kyber_plantard_ntt_rv64: $(SOURCES_COMMON) $(SOURCES) $(HEADERS_COMMON) $(KYBERNTTDIR)/ntt_dualissue_plant_rv64im.S
	mkdir -p out
	$(CC) $(CFLAGS_RV64IM) -I$(KYBERNTTDIR) $(filter %.c, $^) $(filter %.S, $^) -o $@

out/speed_dualissue_kyber_plantard_l32_ntt_rv64: $(SOURCES_COMMON) $(SOURCES) $(HEADERS_COMMON) $(KYBERNTTDIR)/ntt_dualissue_l32_plant_rv64im.S
	mkdir -p out
	$(CC) $(CFLAGS_RV64IM) -I$(KYBERNTTDIR) $(filter %.c, $^) $(filter %.S, $^) -o $@

out/speed_dualissue_dilithium_plant_ntt_rv64: $(SOURCES_COMMON) $(SOURCES) $(HEADERS_COMMON) $(DILITHIUMNTTDIR)/ntt_dualissue_plant_rv64im.S
	mkdir -p out
	$(CC) $(CFLAGS_RV64IM) -I$(DILITHIUMNTTDIR) $(filter %.c, $^) $(filter %.S, $^) -o $@

out/speed_dualissue_kyber_mont_ntt_rvv: $(SOURCES_COMMON) $(SOURCES) $(HEADERS_COMMON) $(KYBERNTTDIR)/ntt_rvv_vlen128.S $(KYBERNTTDIR)/consts_vlen128.c $(KYBERNTTDIR)/ntt_rvv_vlen256.S $(KYBERNTTDIR)/consts_vlen256.c
	mkdir -p out
	$(CC) $(CFLAGS_RV64IMV) -I$(KYBERNTTDIR) -DRVV $(filter %.c, $^) $(filter %.S, $^) -o $@

out/speed_dualissue_dilithium_mont_ntt_rvv: $(SOURCES_COMMON) $(SOURCES) $(HEADERS_COMMON) $(DILITHIUMNTTDIR)/ntt_rvv_vlen128.S $(DILITHIUMNTTDIR)/consts_vlen128.c
	mkdir -p out
	$(CC) $(CFLAGS_RV64IMV) -I$(DILITHIUMNTTDIR) -DRVV $(filter %.c, $^) $(filter %.S, $^) -o $@

clean:
	rm -rf out/
