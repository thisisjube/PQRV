CC = gcc
OBJDUMP = objdump
SCP 	= scp

COMMONDIR 		= ../common

CFLAGS_COMMON 	= -Wall -Wextra -Wpedantic -Wmissing-prototypes -Wredundant-decls \
  				  -Wshadow -Wpointer-arith -O3 -fomit-frame-pointer  \
				  -I$(COMMONDIR) -I.

CFLAGS_RV64IMB 	= $(CFLAGS_COMMON) -march=rv64imadc_zba_zbb -mabi=lp64d -DRV64=1 -DRV64B
CFLAGS_RV64IMV 	= $(CFLAGS_COMMON) -march=rv64imacv -mabi=lp64d -DVECTOR128 -DRV64=1
CFLAGS_RV64IMBV = $(CFLAGS_COMMON) -march=rv64imacv_zba_zbb -mabi=lp64d -DVECTOR128 -DRV64=1

SOURCES_COMMON 	= $(COMMONDIR)/cpucycles.c $(COMMONDIR)/speed_print.c
HEADERS_COMMON 	= $(COMMONDIR)/cpucycles.h $(COMMONDIR)/speed_print.h

.PHONY: all run_all clean

all: \
	out/cpi_rv64imb out/cpi_rvv

run_all: out/cpi_rv64imb out/cpi_rvv
	perf stat ./out/cpi_rv64imb > cpi_rv64imb_x60.txt 2>/dev/null
	perf stat ./out/cpi_rvv > cpi_rvv_x60.txt 2>/dev/null

out/cpi_rv64imb: $(SOURCES_COMMON) $(HEADERS_COMMON) test_rv_im.S test_cpi.c
	mkdir -p out
	$(CC) $(CFLAGS_RV64IMB) $(filter %.c, $^) $(filter %.S, $^) -o $@

out/cpi_rvv: $(SOURCES_COMMON) $(HEADERS_COMMON) test_rv_v.S test_cpi.c
	mkdir -p out
	$(CC) $(CFLAGS_RV64IMV) $(filter %.c, $^) $(filter %.S, $^) -o $@

clean:
	rm -rf out/
